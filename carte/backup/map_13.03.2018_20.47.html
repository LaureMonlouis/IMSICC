<!doctype html>
<html lang="fr">
<head>
    <title>Carte BTS</title>
    <meta charset="utf-8">
    <link rel="stylesheet" href="style.css">
    
    <!-- leaflet -->
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.1/dist/leaflet.css"
          integrity="sha512-Rksm5RenBEKSKFjgI3a41vrjkw4EVPlJ3+OiI65vTjIdo9brlAacEuKOiQ5OFh7cOI1bkDwLqdLw3Zg0cRJAAQ=="
          crossorigin=""/>
    
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"
            integrity="sha512-/Nsx9X4HebavoBvEBuyp3I7od5tA0UzAxs+j83KgC8PU0kgB4XiK4Lfe4y4cgBtaRJQEIFCW+oC506aPT2L1zw=="
            crossorigin="">
    </script>
	
	<!--Bootstrap-->
	
	<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
	<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    
    <!--Data (GeoJSON)-->
    
    <script type="text/javascript" src="datas.js"></script>

</head>    
    
<body style="background-color:black;">
	
	
<nav class="navbar navbar-inverse">
	<div class="container-fluid">
		<div class="navbar-header">
			<a class="navbar-brand">Carte BTS</a>
		</div>
		<ul class="nav navbar-nav">
			<li class="active"><a href="#">Analyse</a></li>
			<li><a href="#">Live</a></li>
			<li><a href="details.html">Détails BTS</a></li>
			<li><a href="mcc_mnc.html">MCC MNC</a></li>
		</ul>
	</div>
</nav>	
	
<div class="container-fluid">
	
	<div class="row">
		<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><p></p></div>
	</div>	
		
	<div class="row">
			
		<!--xs (phones), sm (tablets), md (desktops), and lg (larger desktops)-->
		<div class="col-xs-8 col-sm-8 col-md-9 col-lg-9">
			
			<!-- CARTE -->
			<div id="mapid"></div>

			<script>
				
				//*****************************************************//
				//**    Create Icon Type Base Station for Markers    **//
				//*****************************************************//

				var bs = L.icon(
				{
					iconUrl: 'bs_noire.png',
					iconSize:     [30, 40], // size of the icon
					iconAnchor:   [15, 40], // point of the icon which will correspond to marker's location
					popupAnchor:  [0, -35] // point from which the popup should open relative to the iconAnchor
				});

				var bs_red = L.icon(
				{
					iconUrl: 'bs_red.png',
					iconSize:     [30, 40], // size of the icon
					iconAnchor:   [15, 40], // point of the icon which will correspond to marker's location
					popupAnchor:  [0, -35] // point from which the popup should open relative to the iconAnchor
				});
				
				//*****************************************************//
				//**    Filtering Data							     **//
				//*****************************************************//
				
				// List of GeoJSON : all valide BTS
				var valides = $(datas).filter(
					function (i, item)
					{
						return item.properties.score==='valide';
					});
				
				// List of GeoJSON : all invalide BTS
				var invalides = $(datas).filter(
					function (i, item)
					{
						return item.properties.score==='invalide';
					});
				
				// Reformatage pour utiliser val et inv dans L.GeoJSON(...).addTo(mymap)
				var val = [];
				var inv = [];
				
				for(var iter = 0; iter < valides.length; iter++)
				{
    				val.push(valides[iter]);
				}
				
				for(var iter = 0; iter < invalides.length; iter++)
				{
    				inv.push(invalides[iter]);
				}
				
				// Filter BTS dynamically
				
				// Nombre de BTS affichées dans la map
				var cmpt_bts = 0;
				
				// First filtering on page load
				function filterInit(feature)
				{
					// Récupération de LatLngBounds quand centre sur Rennes avec zoom de 13
					// Ecrit en dur puisque mymap pas encore initilisé
					
					var southWest = [48.077620181726886, -1.7373847961425783];
					var northEast = [48.146388737492565, -1.610698699951172];
					var current_bounds = L.latLngBounds(southWest, northEast);
					
					if(current_bounds.contains(feature.geometry.coordinates))
					{
						cmpt_bts += 1;
						return true;	
					}
				}
				
				// Get only the BTS contained inside map bounds.
				function filterBTS(bounds_map)
				{					
					var cids = $(datas).filter(
					function (i, item)
					{
						return bounds_map.contains(item.geometry.coordinates);
					});
					
					return cids;
				}

				//*****************************************************//
				//*******           Create map                  *******//
				//*****************************************************//

				// Create LayerGroup to conrol similar layers
				var valLG = L.layerGroup();
				var invLG = L.layerGroup();
				
				var valLayer = L.geoJSON(val,
				{
					onEachFeature: onEachFeature,

					pointToLayer: function (feature)
					{
						return L.marker(feature.geometry.coordinates, {icon: bs});
					},
					
					filter: filterInit
				});

				var invLayer = L.geoJSON(inv,
				{
					onEachFeature: onEachFeature,

					pointToLayer: function (feature)
					{
						return L.marker(feature.geometry.coordinates, {icon: bs_red});
					},
					
					filter: filterInit
				});
				
				valLG.addLayer(valLayer);
				invLG.addLayer(invLayer);
				
				var mymap = L.map('mapid',
				{
					center: [48.112, -1.674],
					zoom: 13,
					layers: [valLayer, invLayer]
				});
				
				var fond = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
				{
					maxZoom: 18,
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery © <a href="http://mapbox.com">Mapbox</a>',
					id: 'mapbox.streets'
				}).addTo(mymap);
				
				var satellite = L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw',
				{
					maxZoom: 18,
					attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
					'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
					'Imagery © <a href="http://mapbox.com">Mapbox</a>',
					id: 'mapbox.streets-satellite'
				});
				
				//*****************************************************//
				//*******           Listeners                   *******//
				//*****************************************************//

				//****** OnHovered listener
				// Event listener for layer mouseover event

				function highlightFeature(e)        
				{
					var layer = e.target;

					info.update(layer.feature);
				}

				//****** OnHovered listener
				// Go back to the original state of the GeoJSON when mouse out

				function resetHighlight(e)          
				{
					info.update();
				}

				function zoomFeature(e)
				{
					mymap.flyTo(e.target.getLatLng(), 16);
				}

				// For each data from datas
				function onEachFeature(feature, layer)
				{
					var name = 'Plus d\'informations sur <b><a href="details.html">' + feature.properties.name + '</a></b>';

					layer.bindPopup(name);

					layer.on({
						mouseover: highlightFeature,
						mouseout: resetHighlight,
						click: zoomFeature
					});
				}

				//*****************************************************//
				//*******           Controle	                *******//
				//*****************************************************//
				
				var baseMaps = {
					"OpenStreetMap": fond,
					"Satellite": satellite
				};
				
				var overlayMaps =
				{
					"BTS Valides": valLayer,
					"BTS invalides": invLayer
				};
				
				L.control.layers(baseMaps, overlayMaps).addTo(mymap);
				
				L.control.scale({maxWidth: 200, imperial: false}).addTo(mymap);
				
				//*****************************************************//
				//*******           Info Makers                 *******//
				//*****************************************************//

				var info = L.control({position: 'bottomright'});

				info.onAdd = function (map)
				{
					this._div = L.DomUtil.create('div', 'info'); // create a div with a class "info"
					this.update();
					return this._div;
				};

				// Method that we will use to update the control based on feature properties passed
				info.update = function (feature)
				{
					this._div.innerHTML = '<h4>Base Station ' +
						(feature
						 ? '' + feature.properties.name + '</h4><b>lac</b> : ' + feature.properties.lac + ', <b>cid</b> : ' + feature.properties.cid + '<br/><b>mcc</b> : ' + feature.properties.mcc + ', <b>mnc</b> : ' + feature.properties.mnc + '<br/>'
						 : '</h4>Survolez une Base Station');
				};

				info.addTo(mymap);
				
				//*****************************************************//
				//*******           Interractions               *******//
				//*****************************************************//
				
				function search(feature)
				{
					// Get user inputs
					
					var lac = document.getElementById("lac").value;
					var cid = document.getElementById("cid").value;
					var mcc = document.getElementById("mcc").value;
					var mnc = document.getElementById("mnc").value;
					var typeBS = document.querySelector('input[name="optradio"]:checked').value;
					var city = document.getElementById("sel").value;		
					
					// Handle the lac cid mcc mnc inputs
					
					
					// Handle the type radio button
					
					
					
					// Handle the city selector
					
					switch (city)
					{
						case "mpl":
							mymap.flyTo([43.611, 3.877], 13);
							break;
						case "rns":
							mymap.flyTo([48.112, -1.674], 13);
							break;
						case "nte":
							mymap.flyTo([47.218, -1.554], 13);
							break;
						case "par":
							mymap.flyTo([48.867, 2.333], 13);
							break;
						default:
							console.log("Ne rien faire");
					}
					
				}
				
				mymap.on('moveend', function (e)
				{
					console.log('< moveend YOUPI ! >');
					
					var bounds = mymap.getBounds();
					
					var current_cids = filterBTS(bounds);
					
					cmpt_bts = current_cids.length;
				
					// List of GeoJSON : all valide BTS among current_cids
					var c_val = $(current_cids).filter(
						function (i, item)
						{
							return item.properties.score==='valide';
						});

					// List of GeoJSON : all invalide BTS among current_cids
					var c_inv = $(current_cids).filter(
						function (i, item)
						{
							return item.properties.score==='invalide';
						});

					// Reformatage pour utiliser val et inv dans L.GeoJSON(...).addTo(mymap)
					var current_val = [];
					var current_inv = [];

					for(var iter = 0; iter < c_val.length; iter++)
					{
						current_val.push(c_val[iter]);
					}

					for(var iter = 0; iter < c_inv.length; iter++)
					{
						current_inv.push(c_inv[iter]);
					}
					
					var currentValLayer = L.geoJSON(current_val,
					{
						onEachFeature: onEachFeature,

						pointToLayer: function (feature)
						{
							return L.marker(feature.geometry.coordinates, {icon: bs});
						}
					});					
					
	
					var currentInvLayer = L.geoJSON(current_inv,
					{
						onEachFeature: onEachFeature,

						pointToLayer: function (feature)
						{
							return L.marker(feature.geometry.coordinates, {icon: bs_red});
						}
					});

					valLG.clearLayers();
					invLG.clearLayers();
					
					valLG.addLayer(currentValLayer);
					invLG.addLayer(currentInvLayer);

					valLG.addTo(mymap);
					invLG.addTo(mymap);
				});

			</script>
			
			<!-- FIN CARTE -->
			
		</div>

		<div class="col-xs-4 col-sm-4 col-md-3 col-lg-3" style="background-color:whitesmoke;">
			
			<!-- MENU DE RECHERCHE -->
			<h3><center><b>Recherche sur les BTS</b></center></h3>
			
			<div class="row">
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
					<form>
						<div class="form-group">
						  <label for="lac">LAC</label>
						  <input type="text" class="form-control input-sm" id="lac">
						</div>
						<div class="form-group">
						  <label for="cid">CID</label>
						  <input type="text" class="form-control input-sm" id="cid">
						</div>
					</form>
				</div>
				<div class="col-xs-6 col-sm-6 col-md-6 col-lg-6">
					<form>
						<div class="form-group">
							<label for="mcc">MCC</label>
							<input type="text" class="form-control input-sm" id="mcc">
						</div>
						<div class="form-group">
							<label for="mnc">MNC</label>
							<input type="text" class="form-control input-sm" id="mnc">
						</div>
					</form>
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<center>__________________________________</center><br />
				</div>
			</div>
		
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<p>Quelles BTS souhaitez vous afficher ?</p>
					<center>
					<form>
						<label class="radio-inline">
							<input type="radio" name="optradio" id="val"><b>Valides</b>
						</label>
						<label class="radio-inline">
							<input type="radio" name="optradio" id="inv"><b>Invalides</b>
						</label>
						<label class="radio-inline">
							<input type="radio" name="optradio" id="tts" checked="checked"><b>Toutes</b>
						</label>
					</form>
					</center>
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<center>__________________________________</center><br />
				</div>
			</div>			
			
			<form>
				<div class="form-group">
					<label for="sel">Sélectionnez une ville :</label>
					<select class="form-control" id="sel">
						<option value="vil">--</option>
						<option value="mpl">Montpellier (34)</option>
						<option value="rns">Rennes (35)</option>
						<option value="nte">Nantes (44)</option>
						<option value="par">Paris (75)</option>
					</select>
				</div>
			</form>
		
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<center>__________________________________</center><br />
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<button type="button" class="btn btn-default btn-sm btn-block" onclick="search()"><b>Lancer la recherche</b></button>
				</div>
			</div>
			
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><p></p></div>
			</div>
			
			<!-- FIN MENU DE RECHERCHE -->
			
			<div class="row" style="background-color:black;">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12"><p></p></div>
			</div>
			
			<!-- STATISTIQUES -->
			
			<div class="row">
				<div class="col-xs-12 col-sm-12 col-md-12 col-lg-12">
					<h3><center><b>Statistiques</b></center></h3>
					
					<p>Nombre de BTS affichées : <b id="nb_tot"></b></p>
				</div>
			</div>
			
			<script>
				mymap.on('moveend', function (e)
				{
					document.getElementById("nb_tot").innerHTML = cmpt_bts;
				});
			</script>
				
			<!-- STATISTIQUES -->
			
		</div>
				
	</div>

		
</div>
    
</body>
    
</html>

<!--

Pour charles:

			var tmp = mymap.getBounds().toBBoxString();

			var noth = mymap.getBounds().getNorth();
			var east = mymap.getBounds().getEast();
			var south = mymap.getBounds().getSouth();
			var west = mymap.getBounds().getWest();
			
			console.log(tmp);
			console.log('north : ' + noth);
			console.log('east : ' + east);
			console.log('south : ' + south);
			console.log('west : ' + west);

Dans zoomFeature par exemple, renvoie : -1.7745311146735725,48.04344365312847,-1.573275797567977,48.180792602398846
= Corner1 et Corner2

Voir aussi : http://leafletjs.com/reference-1.3.0.html#latlngbounds
getSouthWest()	LatLng
getNorthEast()	LatLng
getNorthWest()	LatLng
getSouthEast()	LatLng
OU
getWest()	Number
getSouth()	Number
getEast()	Number
getNorth()	Number

-->


<!--<option value="bourg">Bour-en-Bresse (01)</option>
<option value="laon">Laon (02)</option>
<option value="moulins">Moulins (03)</option>
<option value="digne">Digne (04)</option>
<option value="gap">Gap (05)</option>
<option value="nice">Nice (06)</option>
<option value="privas">Privas (07)</option>
<option value="charleville">Charleville-Mézières (08)</option>
<option value="foix">Foix (09)</option>
<option value="troyes">Troyes (10)</option>
<option value="carcassonne">Carcassonne (11)</option>
<option value="rodez">Rodez (12)</option>
<option value="marseille">Marseille (13)</option>
<option value="caen">Caen (14)</option>
<option value="aurillac">Aurilac (15)</option>
<option value="angouleme">Angoulême (16)</option>
<option value="larochelle">La Rochelle (17)</option>
<option value="bourges">Bourges (18)</option>
<option value="tulle">Tulle (19)</option>
<option value="ajaccio">Ajaccio (2A)</option>
<option value="bastia">Bastia (2B)</option>
<option value="dijon">Dijon (21)</option>
<option value="saintbrieuc">Saint-Brieuc (22)</option>
<option value="gueret">Guéret (23)</option>
<option value="perigueux">Périgueux (24)</option>
<option value="besancon">Besançon (25)</option>
<option value="lille">Valence (26)</option>
<option value="evreux">Evreux (27)</option>
<option value="chartres">Chartres (28)</option>
<option value="quimper">Quimper (29)</option>
<option value="nimes">Nîmes (30)</option>
<option value="toulouse">Toulouse (31)</option>
<option value="auch">Auch (32)</option>
<option value="bordeaux">Bordeaux (33)</option>
<option value="montpellier">Montpellier (34)</option>
<option value="rennes">Rennes (35)</option>
<option value="chateauroux">chateauroux (36)</option>
<option value="tours">Tours (37)</option>
<option value="grenoble">Grenoble (38)</option>
<option value="lons">Lons-le-Saunier (39)</option>
<option value="montdemarsan">Mont-de-Marsan (40)</option>
<option value="blois">Blois (41)</option>
<option value="saintetienne">Saint-Etienne (42)</option>
<option value="lepuyenvelay">Le Puy-en-Velay (43)</option>
<option value="nantes">Nantes (44)</option>
<option value="orleans">Orléans (45)</option>
<option value="cahors">Cahors (46)</option>
<option value="agen">Agen (47)</option>
<option value="mende">Mende (48)</option>
<option value="angers">Angers (49)</option>
<option value="saintlo">Saint-Lô (50)</option>
<option value="chalons">Châlons-en-Champagne (51)</option>
<option value="chaumont">Chaumont (52)</option>
<option value="laval">Laval (53)</option>
<option value="nancy">Nancy (54)</option>
<option value="barleduc">Bar-le-Duc (55)</option>
<option value="vannes">Vannes (56)</option>
<option value="metz">Metz (57)</option>
<option value="nevers">Nevers (58)</option>
<option value="lille">Lille (59)</option>
<option value="beauvais">Beauvais (60)</option>
<option value="alencon">Alençon (61)</option>
<option value="arras">Arras (62)</option>
<option value="clermont">Clermont-Ferrand (63)</option>
<option value="pau">Pau (64)</option>
<option value="tarbes">Tarbes (65)</option>
<option value="perpignan">Perpignan (66)</option>
<option value="strasbourg">Strasbourg (67)</option>
<option value="colmar">Colmar (68)</option>
<option value="lyon">Lyon (69)</option>
<option value="vesoul">Vesoul (70)</option>
<option value="macon">Mâcon (71)</option>
<option value="lemans">Le Mans (72)</option>
<option value="chambery">Chambéry (73)</option>
<option value="annecy">Annecy (74)</option>
<option value="paris">Paris (75)</option>
<option value="rouen">Rouen (76)</option>
<option value="melun">Melun (77)</option>
<option value="versailles">Versailles (78)</option>
<option value="niort">Niort (79)</option>
<option value="amiens">Amiens (80)</option>
<option value="albi">Albi (81)</option>
<option value="montauban">Montauban (82)</option>
<option value="toulon">Toulon (83)</option>
<option value="avignon">Avignon (84)</option>
<option value="larochesuryon">La-Roche-sur-Yon (85)</option>
<option value="poitiers">Poitiers (86)</option>
<option value="limoges">Limoges (87)</option>
<option value="epinal">Epinal (88)</option>
<option value="auxerre">Auxerre (89)</option>
<option value="belfort">Belfort (90)</option>
<option value="evry">Evry (91)</option>
<option value="nanterre">Nanterre (92)</option>
<option value="bobigny">Bobigny (93)</option>
<option value="creteil">Créteil (94)</option>
<option value="pontoise">Pontoise (95)</option>-->